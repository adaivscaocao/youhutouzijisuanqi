<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼˜å¼§Â·CSOç§»åŠ¨å†³ç­–ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/alpinejs/3.12.0/cdn.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background-color: #f1f5f9; 
            color: #0f172a; 
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px; /* åº•éƒ¨å¯¼èˆªç•™ç™½ */
        }
        [x-cloak] { display: none !important; }

        /* ç§»åŠ¨ç«¯å¡ç‰‡ */
        .mobile-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            margin-bottom: 16px;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ ç»ç’ƒæ•ˆæœ */
        .mobile-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* ä¼˜åŒ–æ»‘å—è§¦æ‘¸åŒºåŸŸ */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent; height: 24px; margin: 0;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: #2563eb; cursor: pointer; margin-top: -10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: 2px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #cbd5e1; border-radius: 2px;
        }

        /* åº•éƒ¨å¯¼èˆª */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #e2e8f0;
            display: flex; justify-content: space-around;
            padding: 12px 0 24px 0; /* é€‚é…å…¨é¢å±åº•éƒ¨ */
            z-index: 50;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #94a3b8; font-size: 10px; font-weight: 600;
            transition: all 0.2s;
        }
        .nav-item.active { color: #2563eb; transform: translateY(-2px); }
        .nav-icon { width: 24px; height: 24px; margin-bottom: 2px; }

        /* æŠ˜å é¢æ¿åŠ¨ç”» */
        .accordion-content { transition: max-height 0.3s ease-out; max-height: 0; overflow: hidden; }
        .accordion-content.open { max-height: 1000px; }
        
        /* è¿·ä½ è¾“å…¥æ¡† */
        .input-mini {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;
            padding: 4px 8px; font-weight: bold; text-align: right; width: 100%;
            font-size: 12px; color: #334155;
        }
        .input-mini:focus { border-color: #3b82f6; outline: none; background: #fff; }
    </style>
</head>
<body>

<div x-data="mobileSystem()" x-init="initCharts()" x-cloak>

    <!-- é¡¶éƒ¨ Header -->
    <div class="mobile-header fixed top-0 w-full z-40 px-5 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-slate-900 rounded-xl flex items-center justify-center text-white font-black text-lg shadow-lg">ä¼˜</div>
            <div>
                <h1 class="font-black text-slate-900 text-sm leading-none">ä¼˜å¼§æˆ˜ç•¥æ¨æ¼”</h1>
                <p class="text-[9px] text-slate-400 font-bold uppercase mt-0.5">V16 Mobile Elite</p>
            </div>
        </div>
        <!-- ç®€æŠ¥ -->
        <div class="text-right">
            <div class="text-[9px] text-slate-400 font-bold uppercase">å›æœ¬å‘¨æœŸ</div>
            <div class="text-xl font-black text-indigo-600 leading-none"><span x-text="paybackPeriod"></span> <span class="text-xs">æœˆ</span></div>
        </div>
    </div>

    <!-- å†…å®¹åŒºåŸŸ -->
    <div class="pt-24 px-4 pb-4">

        <!-- ============ è§†å›¾ 1: å†³ç­–å¤§å± (Dashboard) ============ -->
        <div x-show="currentTab === 'dashboard'" class="space-y-4">
            
            <!-- æ™ºèƒ½è¯Šæ–­æ¡ -->
            <div class="mobile-card p-4 bg-gradient-to-br from-indigo-50 to-white border-indigo-100">
                <div class="flex items-start gap-3">
                    <div class="mt-0.5 text-indigo-600 bg-indigo-100 p-1.5 rounded-lg">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <div>
                        <h3 class="text-xs font-black text-indigo-900 uppercase tracking-wide mb-1">CSO ç»è¥è¯Šæ–­</h3>
                        <p class="text-xs text-slate-600 leading-relaxed">
                            å½“å‰é…ç½®: <strong class="text-indigo-700" x-text="coach.totalStudents"></strong> ç”Ÿæº / <strong class="text-indigo-700" x-text="coach.count"></strong> æ•™ç»ƒã€‚
                            äººå‡è´Ÿè· <strong :class="loadStatus.color" x-text="studentsPerCoach"></strong> äºº/æ•™ã€‚
                            <br>
                            çŠ¶æ€: <span class="font-bold px-1.5 py-0.5 rounded text-[10px] bg-slate-100" :class="loadStatus.color" x-text="loadStatus.msg"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- KPI çŸ©é˜µ (2x2) -->
            <div class="grid grid-cols-2 gap-3">
                <div class="mobile-card p-4 flex flex-col justify-center text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">å¯åŠ¨èµ„é‡‘ (ä¸‡)</p>
                    <p class="text-2xl font-black text-slate-800 mt-1">Â¥<span x-text="(totalInitialInvest/10000).toFixed(1)"></span></p>
                </div>
                <div class="mobile-card p-4 flex flex-col justify-center text-center bg-slate-900 text-white shadow-lg border-none">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">æœˆå‡€åˆ©æ¶¦</p>
                    <p class="text-2xl font-black text-emerald-400 mt-1">Â¥<span x-text="Math.round(avgMonthlyProfit/1000) + 'k'"></span></p>
                </div>
                <div class="mobile-card p-4 flex flex-col justify-center text-center border-b-4 border-orange-400">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">æœˆç°é‡‘æµ</p>
                    <p class="text-2xl font-black text-orange-500 mt-1">Â¥<span x-text="Math.round(franchiseeNetCash/1000) + 'k'"></span></p>
                </div>
                <div class="mobile-card p-4 flex flex-col justify-center text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">å‡€åˆ©æ¶¦ç‡</p>
                    <p class="text-2xl font-black text-blue-600 mt-1"><span x-text="((avgMonthlyProfit/avgMonthlyRevenue)*100).toFixed(0)"></span>%</p>
                </div>
            </div>

            <!-- ä¸»å›¾è¡¨ -->
            <div class="mobile-card p-5">
                <h3 class="text-xs font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <span class="w-1 h-4 bg-blue-600 rounded-full"></span> èµ„é‡‘å›æµæ¨æ¼” (24ä¸ªæœˆ)
                </h3>
                <div class="h-[220px] w-full relative">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <!-- è¥æ”¶ç»“æ„ -->
            <div class="mobile-card p-5">
                <h3 class="text-xs font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <span class="w-1 h-4 bg-purple-500 rounded-full"></span> è¥æ”¶å»å‘ç»“æ„
                </h3>
                <div class="flex items-center justify-between">
                    <div class="w-1/2 space-y-2 text-[10px] text-slate-500 font-medium">
                        <div class="flex justify-between"><span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-slate-300"></span> æˆ¿ç§Ÿè¿è¥</span> <span><span x-text="((global.rent/avgMonthlyRevenue)*100).toFixed(0)"></span>%</span></div>
                        <div class="flex justify-between"><span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-400"></span> å‘˜å·¥è–ªèµ„</span> <span><span x-text="((avgStaffCost/avgMonthlyRevenue)*100).toFixed(0)"></span>%</span></div>
                        <div class="flex justify-between"><span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-purple-400"></span> æ€»éƒ¨æƒç›Š</span> <span><span x-text="((avgHqCost/avgMonthlyRevenue)*100).toFixed(0)"></span>%</span></div>
                        <div class="flex justify-between font-bold text-emerald-600"><span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> å‡€åˆ©æ¶¦</span> <span><span x-text="((avgMonthlyProfit/avgMonthlyRevenue)*100).toFixed(0)"></span>%</span></div>
                    </div>
                    <div class="w-1/2 h-[130px] relative flex justify-end">
                        <canvas id="doughnutChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ è§†å›¾ 2: å‚æ•°é…ç½® (Config) ============ -->
        <div x-show="currentTab === 'config'" class="space-y-4">
            
            <!-- æ¨¡å— A: è¿è¥æ ¸å¿ƒ (æœ€å¸¸è°ƒ) -->
            <div class="mobile-card p-5 border-l-4 border-blue-500">
                <h3 class="text-sm font-black text-slate-800 mb-5 flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-600 p-1 rounded">ğŸ†</span> æ ¡åŒºè¿è¥æ¨¡å‹
                </h3>
                
                <!-- æ€»ç”Ÿæº -->
                <div class="mb-6">
                    <div class="flex justify-between items-end mb-2">
                        <label class="text-xs font-bold text-slate-500">æ ¡åŒºæ€»ç”Ÿæº</label>
                        <span class="text-2xl font-black text-blue-600" x-text="coach.totalStudents"></span>
                    </div>
                    <input type="range" min="50" max="400" step="10" x-model="coach.totalStudents" @input="updateAll()" class="accent-blue-600">
                    <div class="flex justify-between text-[10px] text-slate-300 font-bold mt-1">
                        <span>50</span><span>400</span>
                    </div>
                </div>

                <!-- æ•™ç»ƒäººæ•° -->
                <div class="mb-6 bg-slate-50 p-3 rounded-xl flex justify-between items-center">
                    <label class="text-xs font-bold text-slate-600">æ•™ç»ƒé…ç½®äººæ•°</label>
                    <div class="flex items-center gap-3">
                        <button @click="coach.count = Math.max(1, coach.count-1); updateAll()" class="w-8 h-8 rounded-full bg-white shadow text-slate-600 font-bold text-lg active:scale-95 transition">-</button>
                        <span class="text-xl font-black text-slate-800 w-6 text-center" x-text="coach.count"></span>
                        <button @click="coach.count++; updateAll()" class="w-8 h-8 rounded-full bg-white shadow text-slate-600 font-bold text-lg active:scale-95 transition">+</button>
                    </div>
                </div>

                <!-- è–ªèµ„è¯¦æƒ…æŠ˜å  -->
                <div class="bg-blue-50/50 rounded-xl border border-blue-100 overflow-hidden">
                    <div @click="toggleAccordion('salary')" class="flex justify-between items-center p-3 cursor-pointer active:bg-blue-100 transition">
                        <span class="text-xs font-bold text-blue-800 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            æ•™ç»ƒè–ªèµ„è®¾å®š
                        </span>
                        <span class="text-blue-400 text-xs font-bold" x-text="accordions.salary ? 'æ”¶èµ·' : 'å±•å¼€'"></span>
                    </div>
                    <div class="accordion-content" :class="accordions.salary ? 'open' : ''">
                        <div class="p-3 pt-0 grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] text-slate-400 block mb-1">åº•è–ª+ç»©æ•ˆ</label>
                                <input type="number" x-model="coach.baseTotal" @input="updateAll()" class="input-mini">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400 block mb-1">èŒçº§ææˆ</label>
                                <select x-model="coach.level" @change="updateAll()" class="input-mini text-blue-600">
                                    <option value="K2">K2 (10%)</option>
                                    <option value="K3">K3 (12%)</option>
                                    <option value="K4">K4 (15%)</option>
                                </select>
                            </div>
                        </div>
                        <div class="px-3 pb-3 border-t border-blue-100/50 pt-2 flex justify-between text-[10px]">
                            <span class="text-slate-500">å•äººæœˆè–ªé¢„è§ˆ:</span>
                            <span class="font-bold text-blue-700">Â¥<span x-text="Math.round(payPerCoach).toLocaleString()"></span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¨¡å— B: ç°é‡‘ä¸ç°å® -->
            <div class="mobile-card p-5 border-l-4 border-orange-400">
                <h3 class="text-sm font-black text-slate-800 mb-5 flex items-center gap-2">
                    <span class="bg-orange-100 text-orange-600 p-1 rounded">ğŸ’°</span> ç°é‡‘æµä¸ç°å®ä¿®æ­£
                </h3>
                
                <div class="mb-5">
                    <label class="text-xs font-bold text-slate-500 block mb-2">æœ¬æœˆç°é‡‘æ”¶å• (Sales)</label>
                    <div class="flex items-center gap-2 bg-orange-50 rounded-xl px-4 py-3 border border-orange-100">
                        <span class="text-orange-500 font-bold text-lg">Â¥</span>
                        <input type="number" x-model="cash.monthlySales" @input="updateAll()" class="bg-transparent font-black text-orange-600 text-2xl w-full outline-none" inputmode="numeric">
                    </div>
                </div>

                <div class="flex items-center justify-between py-3 border-t border-slate-100">
                    <span class="text-xs font-bold text-slate-600">ğŸ‚ å¼€å¯æ·¡æ—ºå­£æ³¢åŠ¨</span>
                    <input type="checkbox" x-model="global.seasonality" @change="updateAll()" class="w-5 h-5 accent-orange-500 rounded">
                </div>
                
                <div class="bg-orange-50/50 rounded-xl p-3 mt-2 border border-orange-100">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[10px] font-bold text-orange-800">åº—é•¿ææˆç‚¹</label>
                        <span class="text-xs font-bold text-orange-600 bg-white px-2 py-0.5 rounded shadow-sm" x-text="(manager.rate*100).toFixed(1)+'%'"></span>
                    </div>
                    <input type="range" min="0.01" max="0.08" step="0.005" x-model="manager.rate" @input="updateAll()" class="accent-orange-500">
                </div>
            </div>

            <!-- æ¨¡å— C: æŠ•èµ„å‚æ•° -->
            <div class="mobile-card p-5 border-l-4 border-purple-500">
                <div @click="toggleAccordion('invest')" class="flex justify-between items-center cursor-pointer">
                    <h3 class="text-sm font-black text-slate-800 flex items-center gap-2">
                        <span class="bg-purple-100 text-purple-600 p-1 rounded">ğŸš€</span> åˆå§‹æŠ•èµ„ä¸æƒç›Š
                    </h3>
                    <span class="text-slate-400 text-xs font-bold bg-slate-100 px-2 py-1 rounded" x-text="accordions.invest ? 'æ”¶èµ·' : 'å±•å¼€'"></span>
                </div>
                
                <div class="accordion-content" :class="accordions.invest ? 'open' : ''">
                    <div class="pt-5 grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-slate-400 block mb-1">åŠ ç›Ÿè´¹</label>
                            <input type="number" x-model="invest.franchiseFee" @input="updateAll()" class="input-mini">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-400 block mb-1">ä¿è¯é‡‘</label>
                            <input type="number" x-model="invest.deposit" @input="updateAll()" class="input-mini">
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] text-slate-400 block mb-1">è£…ä¿®ç¡¬è£…è®¾å¤‡</label>
                            <input type="number" x-model="invest.setupCost" @input="updateAll()" class="input-mini text-base">
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-slate-100">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-[10px] font-bold text-purple-800">æ¶ˆè¯¾åˆ†æˆ (Royalty)</label>
                            <span class="text-xs font-bold text-purple-600" x-text="(invest.royaltyRateNum)+'%'"></span>
                        </div>
                        <input type="range" min="0" max="10" step="0.5" x-model="invest.royaltyRateNum" @input="updateAll()" class="accent-purple-500">
                    </div>
                </div>
            </div>

            <!-- å…¨å±€å°å‚æ•° -->
            <div class="grid grid-cols-2 gap-3 pb-8">
                <div class="mobile-card p-3 mb-0">
                    <label class="text-[10px] text-slate-400 block mb-1">æˆ¿ç§Ÿ Rent</label>
                    <input type="number" x-model="global.rent" @input="updateAll()" class="bg-transparent w-full text-right font-bold text-slate-700 outline-none border-b border-transparent focus:border-blue-500 transition">
                </div>
                <div class="mobile-card p-3 mb-0">
                    <label class="text-[10px] text-slate-400 block mb-1">å•ä»· Price</label>
                    <input type="number" x-model="global.avgPrice" @input="updateAll()" class="bg-transparent w-full text-right font-bold text-slate-700 outline-none border-b border-transparent focus:border-blue-500 transition">
                </div>
            </div>

        </div>

    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div class="bottom-nav">
        <div class="nav-item" :class="currentTab === 'dashboard' ? 'active' : ''" @click="currentTab = 'dashboard'">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            <span>å†³ç­–å¤§å±</span>
        </div>
        <div class="nav-item" :class="currentTab === 'config' ? 'active' : ''" @click="currentTab = 'config'">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
            <span>æ ¸å¿ƒå‚æ•°</span>
        </div>
    </div>

</div>

<script>
    // Register Plugins
    Chart.register(ChartDataLabels);

    function mobileSystem() {
        return {
            currentTab: 'dashboard',
            accordions: { salary: true, invest: false },
            
            // --- Models ---
            global: { avgPrice: 80, weeklyFreq: 3.0, rent: 15000, seasonality: false },
            invest: { franchiseFee: 50000, deposit: 20000, setupCost: 120000, monthlyFee: 2000, royaltyRateNum: 5, marketingCost: 3000 },
            coach: { totalStudents: 120, count: 2, baseTotal: 3000, level: 'K2' },
            coachRates: { 'K2': 0.10, 'K3': 0.12, 'K4': 0.15 },
            manager: { base: 4000, rate: 0.03 },
            cash: { monthlySales: 60000 },

            // --- Logic ---
            toggleAccordion(key) { this.accordions[key] = !this.accordions[key]; },

            get studentsPerCoach() { return Math.round(this.coach.totalStudents / this.coach.count); },
            get totalInitialInvest() { return parseInt(this.invest.franchiseFee) + parseInt(this.invest.deposit) + parseInt(this.invest.setupCost); },
            
            get loadStatus() {
                const avg = this.studentsPerCoach;
                if (avg < 20) return { msg: "äººæ•ˆåä½", color: "text-red-500" };
                if (avg <= 45) return { msg: "å¥åº·åŒºé—´", color: "text-emerald-600" };
                return { msg: "è´Ÿè·è¿‡è½½", color: "text-orange-500" };
            },

            // --- Calculation Engine (Consistent with V15) ---
            calculateMonth(monthIndex) {
                let multiplier = 1.0;
                if (this.global.seasonality) {
                    const m = (monthIndex % 12); 
                    if (m === 1 || m === 2 || m === 7 || m === 8) multiplier = 1.5;
                }
                const revenue = this.coach.totalStudents * this.global.weeklyFreq * 4 * this.global.avgPrice * multiplier;
                
                // Staff Cost
                const revenuePerCoach = revenue / this.coach.count;
                let cComm = 0;
                // 10k threshold logic
                if (revenuePerCoach > 10000) {
                    cComm = (revenuePerCoach - 10000) * this.coachRates[this.coach.level];
                }
                const cSales = revenuePerCoach * 0.05; 
                const totalCoachPay = (parseInt(this.coach.baseTotal) + cComm + cSales) * this.coach.count;
                
                // Manager (P&L approx based on revenue)
                const totalManagerPay = parseInt(this.manager.base) + (revenue * this.manager.rate);
                const staff = totalCoachPay + totalManagerPay;

                const rent = parseInt(this.global.rent);
                const marketing = parseInt(this.invest.marketingCost);
                const royalty = revenue * (this.invest.royaltyRateNum / 100);
                const hq = parseInt(this.invest.monthlyFee) + royalty;

                return { revenue, profit: revenue - rent - staff - marketing - hq, staff, hq };
            },

            // Display Averages
            get avgMonthlyRevenue() { return this.calculateMonth(5).revenue; },
            get avgMonthlyProfit() { return this.calculateMonth(5).profit; },
            get avgStaffCost() { return this.calculateMonth(5).staff; },
            get avgHqCost() { return this.calculateMonth(5).hq; },

            // Single Coach Pay Display
            get revenuePerCoach() { return (this.coach.totalStudents * this.global.weeklyFreq * 4 * this.global.avgPrice) / this.coach.count; },
            get payPerCoach() {
                let cComm = this.revenuePerCoach > 10000 ? (this.revenuePerCoach - 10000) * this.coachRates[this.coach.level] : 0;
                return parseInt(this.coach.baseTotal) + cComm + (this.revenuePerCoach * 0.05);
            },

            // Cash Flow Display
            get franchiseeNetCash() {
                const revenue = this.coach.totalStudents * this.global.weeklyFreq * 4 * this.global.avgPrice;
                const cashIn = parseInt(this.cash.monthlySales);
                
                const revenuePerCoach = revenue / this.coach.count;
                let cComm = revenuePerCoach > 10000 ? (revenuePerCoach - 10000) * this.coachRates[this.coach.level] : 0;
                const totalC = (parseInt(this.coach.baseTotal) + cComm + (revenuePerCoach * 0.05)) * this.coach.count;
                const totalM = parseInt(this.manager.base) + (cashIn * this.manager.rate);
                
                const royalty = revenue * (this.invest.royaltyRateNum / 100);
                const hq = parseInt(this.invest.monthlyFee) + royalty;
                
                return cashIn - parseInt(this.global.rent) - totalC - totalM - parseInt(this.invest.marketingCost) - hq;
            },
            
            get paybackPeriod() {
                let cumulative = -this.totalInitialInvest;
                for(let i=1; i<=60; i++) {
                    cumulative += this.calculateMonth(i).profit;
                    if (cumulative >= 0) return i.toFixed(1);
                }
                return ">60";
            },

            // Charts
            mainChart: null,
            doughnutChart: null,

            updateAll() { this.renderCharts(); },

            initCharts() {
                // Main Chart
                const ctxMain = document.getElementById('mainChart').getContext('2d');
                const gradient = ctxMain.createLinearGradient(0, 0, 0, 200);
                gradient.addColorStop(0, 'rgba(37, 99, 235, 0.2)');
                gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');

                this.mainChart = new Chart(ctxMain, {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 12}, (_, i) => i + 1 + 'æœˆ'),
                        datasets: [{
                            type: 'line', label: 'ç´¯è®¡å›æ”¶', data: [], borderColor: '#2563eb', borderWidth: 2, backgroundColor: gradient, fill: true, tension: 0.4, pointRadius: 0, yAxisID: 'y'
                        }, {
                            type: 'bar', label: 'å‡€åˆ©', data: [], backgroundColor: [], borderRadius: 2, yAxisID: 'y1'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } }, scales: { x: { grid: { display: false }, ticks: {font:{size:9}} }, y: { display: false }, y1: { display: false } } }
                });

                // Donut Chart
                const ctxPie = document.getElementById('doughnutChart').getContext('2d');
                this.doughnutChart = new Chart(ctxPie, {
                    type: 'doughnut',
                    data: { labels: ['æˆ¿ç§Ÿ', 'äººåŠ›', 'è¥é”€', 'æ€»éƒ¨', 'å‡€åˆ©'], datasets: [{ data: [], backgroundColor: ['#cbd5e1', '#60a5fa', '#fca5a5', '#c084fc', '#10b981'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, datalabels: { color: '#fff', font: {size:9, weight:'bold'}, formatter: (v, ctx) => { let sum=0; ctx.chart.data.datasets[0].data.forEach(d=>sum+=d); return v>0?Math.round(v*100/sum)+'%':'' } } } }
                });
                this.renderCharts();
            },

            renderCharts() {
                if(!this.mainChart || !this.doughnutChart) return;
                const initial = -this.totalInitialInvest;
                let lineData = [], barData = [], barColors = [], cumulative = initial;

                for(let i=1; i<=12; i++) {
                    const m = this.calculateMonth(i);
                    cumulative += m.profit;
                    lineData.push(cumulative);
                    barData.push(m.profit);
                    barColors.push(m.profit >= 0 ? '#10b981' : '#f43f5e');
                }
                this.mainChart.data.datasets[0].data = lineData;
                this.mainChart.data.datasets[1].data = barData;
                this.mainChart.data.datasets[1].backgroundColor = barColors;
                this.mainChart.update();

                const std = this.calculateMonth(5);
                const profit = Math.max(0, std.profit);
                this.doughnutChart.data.datasets[0].data = [parseInt(this.global.rent), Math.round(std.staff), parseInt(this.invest.marketingCost), Math.round(std.hq), Math.round(profit)];
                this.doughnutChart.update();
            }
        };
    }
</script>
</body>
</html>