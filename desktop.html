<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼˜å¼§Â·é¦–å¸­æˆ˜ç•¥å®˜å…¨æ™¯å†³ç­–ç³»ç»Ÿ (V15 CSOæ——èˆ°ç‰ˆ)</title>
    <!-- æ ·å¼åº“ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å›¾è¡¨åº“ -->
    <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- å›¾è¡¨æ ‡ç­¾æ’ä»¶ (ç”¨äºåœ†ç¯å›¾æ˜¾ç¤º%) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- äº¤äº’é€»è¾‘åº“ -->
    <script src="https://cdn.bootcdn.net/ajax/libs/alpinejs/3.12.0/cdn.min.js" defer></script>
    <!-- é«˜çº§å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #f8fafc; color: #0f172a; }
        [x-cloak] { display: none !important; }

        /* --- é¡¶çº§ UI è´¨æ„Ÿ --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05);
            border-radius: 20px;
        }

        .sidebar {
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            border-right: 1px solid #e2e8f0;
        }

        /* æ¨¡å—åŒ–å¡ç‰‡ */
        .control-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: all 0.2s ease;
        }
        .control-card:hover { border-color: #cbd5e1; box-shadow: 0 8px 16px rgba(0,0,0,0.04); transform: translateY(-1px); }

        /* ç²¾è‡´è¾“å…¥æ¡† */
        .input-bare {
            background: transparent; border: none; border-bottom: 2px solid transparent;
            font-family: 'JetBrains Mono', monospace; font-weight: 700; text-align: right;
            width: 100%; transition: border-color 0.2s; outline: none;
        }
        .input-bare:focus { border-bottom-color: #3b82f6; }
        
        /* è¿·ä½ å¼€å…³ */
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }

        /* è–ªèµ„æ¡çº¹èƒŒæ™¯ */
        .salary-strip {
            background-image: repeating-linear-gradient(45deg, #f8fafc 0, #f8fafc 10px, #fff 10px, #fff 20px);
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="h-screen overflow-hidden flex text-sm">

<div x-data="csoSystem()" x-init="initCharts()" class="flex w-full h-full" x-cloak>

    <!-- ==================== å·¦ä¾§ï¼šæˆ˜ç•¥æ§åˆ¶å¡” (400px) ==================== -->
    <div class="sidebar w-[400px] flex-shrink-0 flex flex-col h-full overflow-y-auto z-30">
        
        <!-- Header -->
        <div class="p-6 sticky top-0 bg-white/95 backdrop-blur z-10 border-b border-slate-100">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white font-black text-lg shadow-xl">ä¼˜</div>
                <div>
                    <h1 class="font-black text-slate-900 text-lg leading-none tracking-tight">ä¼˜å¼§Â·å…¨æ™¯å†³ç­–ç³»ç»Ÿ</h1>
                    <p class="text-[10px] text-slate-500 font-bold tracking-widest uppercase mt-1">V15 CSO Strategy Edition</p>
                </div>
            </div>
        </div>

        <div class="p-6 space-y-8 pb-32">

            <!-- 1. æŠ•èµ„æ¨¡å‹ (Investment) -->
            <div class="space-y-3">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-purple-500"></span> 1. èµ„æœ¬æŠ•å…¥ä¸æƒç›Š
                </h2>
                
                <div class="control-card space-y-3">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">åŠ ç›Ÿè´¹ Franchise</label>
                            <div class="flex items-center bg-slate-50 rounded px-2 py-1.5">
                                <span class="text-xs text-slate-400 mr-1">Â¥</span>
                                <input type="number" x-model="invest.franchiseFee" @input="updateAll()" class="input-bare text-slate-700">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">ä¿è¯é‡‘ Deposit</label>
                            <div class="flex items-center bg-slate-50 rounded px-2 py-1.5">
                                <span class="text-xs text-slate-400 mr-1">Â¥</span>
                                <input type="number" x-model="invest.deposit" @input="updateAll()" class="input-bare text-slate-700">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">ç¡¬è£…è®¾å¤‡ Setup Cost</label>
                        <div class="flex items-center bg-slate-50 rounded px-2 py-1.5">
                            <span class="text-xs text-slate-400 mr-1">Â¥</span>
                            <input type="number" x-model="invest.setupCost" @input="updateAll()" class="input-bare text-slate-700">
                        </div>
                    </div>
                    
                    <!-- æƒç›Šè®¾ç½® -->
                    <div class="pt-3 border-t border-slate-100 grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-purple-600 font-bold block mb-1">æ¶ˆè¯¾åˆ†æˆ Royalty</label>
                            <div class="flex items-center gap-1">
                                <input type="number" x-model="invest.royaltyRateNum" @input="updateAll()" class="input-bare text-purple-600 w-10 border-b border-purple-200">
                                <span class="text-xs font-bold text-purple-400">%</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-purple-600 font-bold block mb-1">æœˆç®¡è´¹ Mgmt Fee</label>
                            <div class="flex items-center gap-1">
                                <span class="text-xs text-purple-400">Â¥</span>
                                <input type="number" x-model="invest.monthlyFee" @input="updateAll()" class="input-bare text-purple-600 border-b border-purple-200">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. è¿è¥ä¸è–ªé…¬ (Operations & HR) -->
            <div class="space-y-3">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-blue-500"></span> 2. è¿è¥äººæ•ˆä¸è–ªé…¬
                </h2>

                <!-- A. æ ¡åŒºè§„æ¨¡ -->
                <div class="control-card border-l-4 border-l-blue-500">
                    <div class="flex justify-between items-end mb-2">
                        <label class="text-xs font-bold text-slate-700">æ ¡åŒºæ€»å­¦å‘˜ Active Students</label>
                        <span class="text-lg font-black text-blue-600" x-text="coach.totalStudents + 'äºº'"></span>
                    </div>
                    <input type="range" min="50" max="400" step="10" x-model="coach.totalStudents" @input="updateAll()" class="w-full accent-blue-600 h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    
                    <!-- æ™ºèƒ½äººæ•ˆåé¦ˆ -->
                    <div class="mt-3 flex justify-between items-center bg-slate-50 p-2 rounded text-[10px]">
                        <span class="text-slate-500 font-bold">äººå‡è´Ÿè·: <span class="text-slate-900" x-text="studentsPerCoach"></span>äºº</span>
                        <span :class="loadStatus.color" class="font-bold uppercase" x-text="loadStatus.msg"></span>
                    </div>
                </div>

                <!-- B. æ•™ç»ƒè–ªèµ„é…ç½® -->
                <div class="control-card bg-blue-50/30 border-blue-100">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-2">
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Coach Team</label>
                            <div class="flex items-center bg-white border border-slate-200 rounded px-1">
                                <button @click="coach.count = Math.max(1, coach.count-1); updateAll()" class="px-2 text-slate-400 hover:text-blue-600 font-bold">-</button>
                                <span class="text-xs font-black w-4 text-center" x-text="coach.count"></span>
                                <button @click="coach.count++; updateAll()" class="px-2 text-slate-400 hover:text-blue-600 font-bold">+</button>
                            </div>
                        </div>
                        <div class="text-[10px] text-blue-600 font-bold">Â¥<span x-text="Math.round(totalCoachPay).toLocaleString()"></span> (æ€»äººåŠ›)</div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="text-[9px] text-slate-400 block mb-1">åº•è–ª+ç»©æ•ˆ</label>
                            <input type="number" x-model="coach.baseTotal" @input="updateAll()" class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-bold text-right">
                        </div>
                        <div>
                            <label class="text-[9px] text-slate-400 block mb-1">èŒçº§ææˆ</label>
                            <select x-model="coach.level" @change="updateAll()" class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-bold text-right text-blue-600">
                                <option value="K2">K2 (10%)</option>
                                <option value="K3">K3 (12%)</option>
                                <option value="K4">K4 (15%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- è¿·ä½ å·¥èµ„æ¡ -->
                    <div class="salary-strip p-2 rounded border border-blue-100/50 text-[10px] text-slate-500 flex justify-between items-center">
                        <span>å•äººæœˆè–ªé¢„è§ˆ:</span>
                        <span class="font-bold text-blue-700">Â¥<span x-text="Math.round(payPerCoach).toLocaleString()"></span></span>
                    </div>
                </div>
            </div>

            <!-- 3. ç°é‡‘ä¸ç°å® (Cash & Reality) -->
            <div class="space-y-3">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-orange-500"></span> 3. ç°é‡‘æµä¸ç°å®ä¿®æ­£
                </h2>

                <div class="control-card border-l-4 border-l-orange-400 space-y-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Cash Sales ç°é‡‘æ”¶å•</label>
                        <div class="flex items-center">
                            <span class="text-orange-500 font-bold text-sm mr-2">Â¥</span>
                            <input type="number" x-model="cash.monthlySales" @input="updateAll()" class="input-bare text-orange-600 text-lg">
                        </div>
                    </div>
                    
                    <!-- åº—é•¿è–ªèµ„ -->
                    <div class="bg-orange-50/50 p-2 rounded border border-orange-100 grid grid-cols-2 gap-2 items-center">
                        <div>
                            <label class="text-[9px] text-slate-400 block">åº—é•¿åº•è–ª</label>
                            <input type="number" x-model="manager.base" @input="updateAll()" class="w-full bg-white border border-orange-200 rounded px-1 py-0.5 text-xs text-right">
                        </div>
                        <div>
                            <label class="text-[9px] text-slate-400 block">ææˆç‚¹ <span class="text-orange-600 font-bold" x-text="(manager.rate*100).toFixed(1)+'%'"></span></label>
                            <input type="range" min="0.01" max="0.08" step="0.005" x-model="manager.rate" @input="updateAll()" class="w-full h-1 bg-orange-200 rounded accent-orange-500">
                        </div>
                    </div>
                </div>

                <!-- ç°å®ä¿®æ­£å‚æ•° -->
                <div class="control-card grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Rent æˆ¿ç§Ÿ</label>
                        <input type="number" x-model="global.rent" @input="updateAll()" class="input-bare text-xs">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Marketing è¥é”€</label>
                        <input type="number" x-model="invest.marketingCost" @input="updateAll()" class="input-bare text-xs text-rose-500">
                    </div>
                    <div class="col-span-2 pt-2 border-t border-slate-100 flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-600">ğŸ‚ å¼€å¯æ·¡æ—ºå­£æ³¢åŠ¨</span>
                        <div class="relative inline-block w-8 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="season-toggle" x-model="global.seasonality" @change="updateAll()" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300"/>
                            <label for="season-toggle" class="toggle-label block overflow-hidden h-4 rounded-full bg-slate-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Global Bottom -->
            <div class="grid grid-cols-2 gap-2 text-[10px]">
                <div class="bg-slate-100 rounded px-2 py-1">
                    <span class="text-slate-400">Avg Price å•ä»·</span>
                    <input type="number" x-model="global.avgPrice" @input="updateAll()" class="bg-transparent font-bold w-full text-right outline-none">
                </div>
                <div class="bg-slate-100 rounded px-2 py-1">
                    <span class="text-slate-400">Frequency é¢‘æ¬¡</span>
                    <input type="number" x-model="global.weeklyFreq" @input="updateAll()" class="bg-transparent font-bold w-full text-right outline-none">
                </div>
            </div>

        </div>
    </div>

    <!-- ==================== å³ä¾§ï¼šå…¨æ™¯å†³ç­–å¤§å± ==================== -->
    <div class="flex-1 h-full overflow-y-auto bg-slate-50/50 p-8 xl:p-12 relative">
        
        <!-- èƒŒæ™¯æ°›å›´ -->
        <div class="fixed top-0 right-0 w-[800px] h-[800px] bg-indigo-100/40 rounded-full mix-blend-multiply blur-[120px] pointer-events-none"></div>

        <div class="max-w-6xl mx-auto space-y-6 relative z-10">
            
            <!-- æ™ºèƒ½è¯Šæ–­æ¡ -->
            <div class="glass-panel p-4 border-l-4 border-indigo-500 flex items-start gap-4">
                <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600 mt-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                </div>
                <div>
                    <h3 class="text-sm font-black text-slate-800">CSO æ™ºèƒ½è¯Šæ–­</h3>
                    <p class="text-xs text-slate-600 mt-1 leading-relaxed">
                        å½“å‰æ¨¡å‹é…ç½®äº† <strong class="text-blue-600" x-text="coach.totalStudents"></strong> åå­¦å‘˜ä¸ <strong class="text-slate-800" x-text="coach.count"></strong> åæ•™ç»ƒã€‚
                        äººå‡è´Ÿè· <strong x-text="studentsPerCoach"></strong> äººï¼Œ
                        <span x-show="studentsPerCoach > 45" class="text-orange-500 font-bold">å¤„äºé«˜è´Ÿè·çŠ¶æ€ï¼Œå»ºè®®å¢åŠ äººæ‰‹ä»¥é˜²æ•™å­¦è´¨é‡ä¸‹é™ã€‚</span>
                        <span x-show="studentsPerCoach <= 45 && studentsPerCoach >= 20" class="text-green-600 font-bold">å¤„äºé»„é‡‘ç›ˆåˆ©åŒºé—´ï¼Œäººæ•ˆä¸ä½“éªŒå¹³è¡¡ã€‚</span>
                        <span x-show="studentsPerCoach < 20" class="text-red-500 font-bold">å¤„äºä½äººæ•ˆåŒºï¼Œéœ€å¢åŠ ç”Ÿæºæˆ–å‡å°‘æ•™ç»ƒã€‚</span>
                        <br>
                        é¢„è®¡å›æœ¬å‘¨æœŸ <strong class="text-indigo-600 bg-indigo-50 px-1 rounded"><span x-text="paybackPeriod"></span> ä¸ªæœˆ</strong>ã€‚
                    </p>
                </div>
            </div>

            <!-- 1. æ ¸å¿ƒæ•°æ®çŸ©é˜µ (KPI) -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                <div class="glass-panel p-5">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Startup Cost (å¯åŠ¨èµ„é‡‘)</p>
                    <p class="text-2xl font-black text-slate-800 mt-1">Â¥<span x-text="(totalInitialInvest/10000).toFixed(1)"></span>ä¸‡</p>
                </div>
                <div class="glass-panel p-5 bg-white border border-slate-200">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Avg. Monthly Revenue</p>
                    <p class="text-2xl font-black text-blue-900 mt-1">Â¥<span x-text="Math.round(avgMonthlyRevenue).toLocaleString()"></span></p>
                    <p class="text-[10px] text-slate-400 mt-1">æ¶ˆè¯¾æ€»äº§å€¼ (æœˆå‡)</p>
                </div>
                <div class="glass-panel p-5 border-l-4 border-l-green-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Net Profit (å‡€åˆ©)</p>
                    <p class="text-2xl font-black" :class="avgMonthlyProfit>=0?'text-green-600':'text-red-500'">Â¥<span x-text="Math.round(avgMonthlyProfit).toLocaleString()"></span></p>
                    <p class="text-[10px] text-slate-400 mt-1">åˆ©æ¶¦ç‡: <span x-text="((avgMonthlyProfit/avgMonthlyRevenue)*100).toFixed(1)"></span>%</p>
                </div>
                <div class="glass-panel p-5 bg-slate-900 text-white shadow-xl shadow-slate-300">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">ROI Period</p>
                    <p class="text-3xl font-black text-yellow-400 mt-1 tracking-tighter"><span x-text="paybackPeriod"></span> <span class="text-sm font-bold text-white opacity-60">Months</span></p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- 2. ä¸»å›¾è¡¨ï¼šä»·å€¼æ¨æ¼” (å  2/3) -->
                <div class="glass-panel p-6 lg:col-span-2 h-[450px] flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2">
                            <span class="w-1.5 h-6 bg-blue-600 rounded-full"></span>
                            èµ„é‡‘å›æµæ¨æ¼” (24ä¸ªæœˆ)
                        </h3>
                        <div class="flex gap-3 text-[10px] font-bold text-slate-500">
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-emerald-500"></span> ç›ˆåˆ©æœˆ</span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-rose-500"></span> äºæŸæœˆ</span>
                            <span class="flex items-center gap-1"><span class="w-6 h-1 rounded bg-blue-600"></span> ç´¯è®¡å›æ”¶</span>
                        </div>
                    </div>
                    <div class="flex-1 relative w-full">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <!-- 3. è¥æ”¶åœ†ç›˜ (Donut Chart) -->
                <div class="glass-panel p-6 lg:col-span-1 flex flex-col">
                    <h3 class="font-bold text-slate-800 text-sm mb-6 flex items-center gap-2">
                        <span class="w-1.5 h-6 bg-purple-500 rounded-full"></span>
                        è¥æ”¶åˆ†é…ç»“æ„ (Revenue Split)
                    </h3>
                    <div class="flex-1 relative">
                        <canvas id="doughnutChart"></canvas>
                        <!-- ä¸­å¿ƒæ–‡å­— -->
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <span class="text-[10px] text-slate-400 font-bold uppercase">Total</span>
                            <span class="text-lg font-black text-slate-800">100%</span>
                        </div>
                    </div>
                    <!-- å›¾ä¾‹ -->
                    <div class="mt-4 grid grid-cols-2 gap-2 text-[10px]">
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-slate-300"></span> æˆ¿ç§Ÿè¿è¥</div>
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-400"></span> å‘˜å·¥è–ªèµ„</div>
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-rose-300"></span> è¥é”€æ¨å¹¿</div>
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-purple-400"></span> æ€»éƒ¨æƒç›Š</div>
                        <div class="flex items-center gap-1 col-span-2"><span class="w-2 h-2 rounded-full bg-green-500"></span> å‡€åˆ©æ¶¦ (Profit)</div>
                    </div>
                </div>

            </div>

            <!-- 4. P&L è´¢åŠ¡åº•è¡¨ -->
            <div class="glass-panel p-0 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800 text-sm">æŸç›Šè¡¨ç»†ç›® (Monthly P&L Statement)</h3>
                    <span class="text-[10px] bg-white border border-slate-200 px-2 py-1 rounded text-slate-500">å•ä½: CNY</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <thead class="text-slate-400 font-bold border-b border-slate-100 bg-slate-50/30">
                            <tr>
                                <th class="py-3 px-6 w-1/3">ç§‘ç›® Item</th>
                                <th class="py-3 px-6 text-right">é‡‘é¢ Amount</th>
                                <th class="py-3 px-6 text-right">å æ¯” %</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50 font-medium text-slate-600">
                            <tr>
                                <td class="py-3 px-6 text-blue-900 font-bold">æ¶ˆè¯¾æ€»è¥æ”¶ Revenue (+)</td>
                                <td class="py-3 px-6 text-right font-bold text-blue-900" x-text="Math.round(avgMonthlyRevenue).toLocaleString()"></td>
                                <td class="py-3 px-6 text-right text-blue-900 font-bold">100%</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-6 pl-10">æˆ¿ç§Ÿç‰©ä¸š Rent (-)</td>
                                <td class="py-2 px-6 text-right" x-text="parseInt(global.rent).toLocaleString()"></td>
                                <td class="py-2 px-6 text-right opacity-60" x-text="((global.rent/avgMonthlyRevenue)*100).toFixed(1) + '%'"></td>
                            </tr>
                            <tr>
                                <td class="py-2 px-6 pl-10">äººåŠ›è–ªèµ„ Staff Cost (-)</td>
                                <td class="py-2 px-6 text-right" x-text="Math.round(avgStaffCost).toLocaleString()"></td>
                                <td class="py-2 px-6 text-right opacity-60" x-text="((avgStaffCost/avgMonthlyRevenue)*100).toFixed(1) + '%'"></td>
                            </tr>
                            <tr>
                                <td class="py-2 px-6 pl-10 text-rose-500">è¥é”€è·å®¢ Marketing (-)</td>
                                <td class="py-2 px-6 text-right text-rose-500" x-text="parseInt(invest.marketingCost).toLocaleString()"></td>
                                <td class="py-2 px-6 text-right opacity-60" x-text="((invest.marketingCost/avgMonthlyRevenue)*100).toFixed(1) + '%'"></td>
                            </tr>
                            <tr>
                                <td class="py-2 px-6 pl-10 text-purple-600">æ€»éƒ¨æƒç›Š HQ Cut (-)</td>
                                <td class="py-2 px-6 text-right text-purple-600" x-text="Math.round(avgHqCost).toLocaleString()"></td>
                                <td class="py-2 px-6 text-right opacity-60" x-text="((avgHqCost/avgMonthlyRevenue)*100).toFixed(1) + '%'"></td>
                            </tr>
                            <tr class="bg-slate-50">
                                <td class="py-4 px-6 font-bold text-slate-800">å‡€åˆ©æ¶¦ Net Profit</td>
                                <td class="py-4 px-6 text-right font-black text-sm" :class="avgMonthlyProfit>=0?'text-green-600':'text-red-600'" x-text="'Â¥' + Math.round(avgMonthlyProfit).toLocaleString()"></td>
                                <td class="py-4 px-6 text-right font-bold" :class="avgMonthlyProfit>=0?'text-green-600':'text-red-600'" x-text="((avgMonthlyProfit/avgMonthlyRevenue)*100).toFixed(1) + '%'"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // Register Plugin
    Chart.register(ChartDataLabels);

    function csoSystem() {
        return {
            // Models
            global: { avgPrice: 80, weeklyFreq: 3.0, rent: 15000, seasonality: false },
            invest: { franchiseFee: 50000, deposit: 20000, setupCost: 120000, monthlyFee: 2000, royaltyRateNum: 5, marketingCost: 3000 },
            coach: { totalStudents: 120, count: 2, baseTotal: 3000, level: 'K2' },
            coachRates: { 'K2': 0.10, 'K3': 0.12, 'K4': 0.15 },
            manager: { base: 4000, rate: 0.03 },
            cash: { monthlySales: 60000 },

            // Computed Helpers
            get studentsPerCoach() { return Math.round(this.coach.totalStudents / this.coach.count); },
            get totalInitialInvest() { return parseInt(this.invest.franchiseFee) + parseInt(this.invest.deposit) + parseInt(this.invest.setupCost); },
            
            // Status Logic
            get loadStatus() {
                const avg = this.studentsPerCoach;
                if (avg < 20) return { msg: "äººæ•ˆåä½ Low", color: "text-red-500" };
                if (avg <= 45) return { msg: "å¥åº·åŒºé—´ Good", color: "text-green-600" };
                return { msg: "è´Ÿè·è¿‡è½½ Overload", color: "text-orange-500" };
            },

            // --- Calculation Engine ---
            calculateMonth(monthIndex) {
                // 1. Revenue with Seasonality
                let multiplier = 1.0;
                if (this.global.seasonality) {
                    const m = (monthIndex % 12); 
                    if (m === 1 || m === 2 || m === 7 || m === 8) multiplier = 1.5; // Peak season
                }
                const revenue = this.coach.totalStudents * this.global.weeklyFreq * 4 * this.global.avgPrice * multiplier;

                // 2. Staff Cost Logic (V14 Logic Embedded)
                const revenuePerCoach = revenue / this.coach.count;
                let cComm = 0;
                // 10k threshold
                if (revenuePerCoach > 10000) {
                    cComm = (revenuePerCoach - 10000) * this.coachRates[this.coach.level];
                }
                const cSales = revenuePerCoach * 0.05; // Est. Sales comm for coach
                // Coach Total
                const totalCoachPay = (parseInt(this.coach.baseTotal) + cComm + cSales) * this.coach.count;
                
                // Manager Total (Based on Cash Sales approx for P&L model or tied to revenue trend)
                // For P&L projection, we assume Cash Sales tracks Revenue closely over time
                const projectedSales = revenue; 
                const totalManagerPay = parseInt(this.manager.base) + (projectedSales * this.manager.rate);
                
                const staff = totalCoachPay + totalManagerPay;

                // 3. Other Costs
                const rent = parseInt(this.global.rent);
                const marketing = parseInt(this.invest.marketingCost);
                const royalty = revenue * (this.invest.royaltyRateNum / 100);
                const hq = parseInt(this.invest.monthlyFee) + royalty;

                const profit = revenue - rent - staff - marketing - hq;

                return { revenue, profit, staff, hq, rent, marketing };
            },

            // Single Coach Display (For Left Panel)
            get revenuePerCoach() { return (this.coach.totalStudents * this.global.weeklyFreq * 4 * this.global.avgPrice) / this.coach.count; },
            get coachClassComm() {
                if (this.revenuePerCoach <= 10000) return 0;
                return (this.revenuePerCoach - 10000) * this.coachRates[this.coach.level];
            },
            get payPerCoach() { return parseInt(this.coach.baseTotal) + this.coachClassComm + (this.revenuePerCoach * 0.05); },
            get totalCoachPay() { return this.payPerCoach * this.coach.count; },

            // Averages for Dashboard
            get avgMonthlyRevenue() { return this.calculateMonth(5).revenue; },
            get avgMonthlyProfit() { return this.calculateMonth(5).profit; },
            get avgStaffCost() { return this.calculateMonth(5).staff; },
            get avgHqCost() { return this.calculateMonth(5).hq; },
            
            get paybackPeriod() {
                let cumulative = -this.totalInitialInvest;
                for(let i=1; i<=60; i++) {
                    cumulative += this.calculateMonth(i).profit;
                    if (cumulative >= 0) return i.toFixed(1);
                }
                return ">60";
            },

            // Charts
            mainChart: null,
            doughnutChart: null,

            updateAll() { this.renderCharts(); },

            initCharts() {
                const ctxMain = document.getElementById('mainChart').getContext('2d');
                const gradient = ctxMain.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(37, 99, 235, 0.2)');
                gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');

                this.mainChart = new Chart(ctxMain, {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 25}, (_, i) => i === 0 ? 'Start' : i + 'æœˆ'),
                        datasets: [{
                            type: 'line', label: 'ç´¯è®¡å›æ”¶', data: [], borderColor: '#2563eb', borderWidth: 3, backgroundColor: gradient, fill: true, tension: 0.4, pointRadius: 0, yAxisID: 'y'
                        }, {
                            type: 'bar', label: 'å‡€åˆ©æ¶¦', data: [], backgroundColor: [], borderRadius: 4, yAxisID: 'y1'
                        }]
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, 
                        plugins: { legend: { display: false }, datalabels: { display: false } }, // Hide datalabels on main chart
                        scales: { x: { grid: { display: false } }, y: { position: 'left', grid: { borderDash: [5,5] } }, y1: { position: 'right', display: false } } 
                    }
                });

                const ctxPie = document.getElementById('doughnutChart').getContext('2d');
                this.doughnutChart = new Chart(ctxPie, {
                    type: 'doughnut',
                    data: {
                        labels: ['æˆ¿ç§Ÿ', 'äººåŠ›', 'è¥é”€', 'æ€»éƒ¨', 'å‡€åˆ©'],
                        datasets: [{
                            data: [],
                            backgroundColor: ['#cbd5e1', '#60a5fa', '#fca5a5', '#c084fc', '#10b981'],
                            borderWidth: 0
                        }]
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false, cutout: '65%', 
                        plugins: { 
                            legend: { display: false },
                            datalabels: {
                                color: '#fff',
                                font: { weight: 'bold', size: 10 },
                                formatter: (value, ctx) => {
                                    let sum = 0;
                                    let dataArr = ctx.chart.data.datasets[0].data;
                                    dataArr.map(data => { sum += data; });
                                    let percentage = (value*100 / sum).toFixed(0)+"%";
                                    return percentage; // Display %
                                },
                                display: function(context) {
                                    return context.dataset.data[context.dataIndex] > 0; // Only show if > 0
                                }
                            }
                        } 
                    }
                });
                this.renderCharts();
            },

            renderCharts() {
                if(!this.mainChart || !this.doughnutChart) return;

                const initial = -this.totalInitialInvest;
                let lineData = [initial], barData = [initial], barColors = ['#f43f5e'], cumulative = initial;

                for(let i=1; i<=24; i++) {
                    const m = this.calculateMonth(i);
                    cumulative += m.profit;
                    lineData.push(cumulative);
                    barData.push(m.profit);
                    barColors.push(m.profit >= 0 ? '#10b981' : '#f43f5e');
                }
                this.mainChart.data.datasets[0].data = lineData;
                this.mainChart.data.datasets[1].data = barData;
                this.mainChart.data.datasets[1].backgroundColor = barColors;
                this.mainChart.update();

                const std = this.calculateMonth(5);
                const profit = Math.max(0, std.profit);
                this.doughnutChart.data.datasets[0].data = [
                    parseInt(this.global.rent),
                    Math.round(std.staff),
                    parseInt(this.invest.marketingCost),
                    Math.round(std.hq),
                    Math.round(profit)
                ];
                this.doughnutChart.update();
            }
        };
    }
</script>
</body>
</html>